---
title: 云服务器使用指南（一）
date: 2021-07-19
categories:
  - 工具
tags:
  - team
  - linux
---

鉴于组里面大部分同学已经购买了自己的云服务器，却还没有很好地利用起来，有必要写一系列的文章详细介绍我们如何利用云服务器去学习程序员的加分技能：Linux，Nginx，Docker 等等。本系列的最终目标是组里面的每一位同学，都能够独立自主地完成组内一整套团队协作工具的部署。

本篇是云服务器使用指南的开篇作，主要内容涵盖：

1. 远程连接基本概念
2. 命令行方式连接云服务器
3. GUI 方式连接云服务器

<!-- more -->

## 远程连接基本概念

要想建立起一个远程连接，我们往往需要知道以下几个问题。

### 连接谁？

要想建立远程连接，首先要知道宿主机在哪，这是一个**网络通信问题**。在网络的世界里，描述机器地址的通常是 ip，就目前而言，是 ipv4。然而因为 ipv4 地址已经极其短缺，甚至“已经用尽”，平常使用的电子设备很难分配到一个真正的 ipv4 地址，这就导致了我们的日常电脑几乎无法在公网环境下互相连接。而云服务器恰恰提供了公网可用的 ipv4 地址，因此可以在公网环境下被精确定位。事实上，这也正是我们使用云服务器的一个主要原因 —— 获取一个公网可用的 ip 地址。至于其他问题都不是大事了，毕竟我们办公室不缺旧电脑，不缺电。

### 怎么连接？

有了公网 ip，我们就可以精确定位到我们想要连接的那台电脑。下一步，我们需要决定以什么样的方式来连接，这是一个**协议问题**。如果宿主机系统是 Linux，通常采用的是 SSH（SHELL）或者 VNC（GUI）；如果宿主机系统是 Windows，通常采用 RDP（GUI）。

这里还涉及了宿主机支不支持的问题，说白了，就是相关的设置或者开关有没有被打开，相应的服务有没有被启动，想要连接的电脑 ip 在不在它的白名单或者黑名单中等等。

### 凭什么让你连接？

前两个知道之后，远程连接的请求将被创建并发送给宿主机，然而对于宿主机来说，不是什么阿猫阿狗都可以连接我的，这就涉及到一个**认证问题**。

一般来说，认证有两种形式。

- 账号密码认证
- 密钥文件认证

## 命令行方式连接云服务器

大家买的云服务器都是**服务器版的 Linux**，没有 Gui 界面，所以都是用 SSH 协议来连接。接下来的内容，我将把云服务器当作一台普通的 Linux Server 来看待，尽量不采用任何的图形交互界面来操作。我希望大家记住，**命令行方式才是根本**，任何的 GUI 操作其本质只是对一系列命令的封装。但是我们永远无法保证未来的环境能否支持我们使用图形交互界面，那么掌握了命令行方式，我们才能以不变应万变，对任何需求都游刃有余。

### 环境介绍

我们以办公室的无线网形成的局域网为例，存在一台 Ubuntu Server 的服务器，默认 ssh 服务已开启，端口为默认的 22。其相关信息包括：

- 局域网 ip 地址：192.168.1.118
- 用户名：taujiong

### 账号密码认证连接

```bash
ssh taujiong@192.168.1.118
```

命令很简单，主要有以下几个注意事项：

- 首次连接一台**主机**时会询问是否要将主机对应的 ip 添加到受信列表中，输入 `yes` 即可，此操作会将主机对应的 ip 添加到文件 `~/.ssh/known_hosts`，删除该文件的内容那么下次连接时又会提醒
- 在没有配置密钥的前提下，会要求输入用户名对应的密码，对于自己安装的系统，那么在安装时设置过；对于云服务器中的系统，密码应该会在你创建实例的时候发给你，注意查看
- Linux 系统对用户密码进行了保护，在输入密码时不会有任何的字符串提示，正常输入即可，不要认为没输入进去

下面，我们对照着远程连接的几个要素，再过一遍：

- 连接谁：根据 ip 地址 192.168.1.118，找到局域网中相应的主机
- 怎么连接：通过 ssh 应用连接
- 凭什么让你连接：首先，我们在命令中指定了要连接的用户，如果主机上不存在相应的用户则主机直接拒绝连接，否则就校验用户输入的密码是否匹配。

对于组内使用云服务器的同学，这里要提醒一下用户名的设置，不同云服务厂商的设置是不一样的。查看的方法就是，首先通过云服务器厂商提供的网页端方式登录到自己的云服务器实例，然后在相应的命令行提示窗口中，查看光标前面的前缀。

我自己安装的 Ubuntu Server 是 `taujiong@taujiong-laptop`，这是我在安装系统时手动填写的，所以我连接时使用的用户名就是 `taujiong`

腾讯云的似乎是 `ubuntu@pulic-ip`，所以连接时使用的用户名就是 `ubuntu`

阿里云的似乎是 `root@pulic-ip`，所以连接时使用的用户名就是 `root`，这个权限更高

### 密钥文件认证连接

大概描述一下基本过程：

1. 打造配套的一把钥匙和一把锁。

   ```bash
   ssh-keygen -t rsa
   ```

   该命令的目的是生成公钥 id_rsa.pub（锁）和私钥 id_rsa（钥匙），默认情况下保存在 `~/.ssh` 文件夹中，如果本地相应位置已经有了这两个文件，可以跳过此步。

2. **以主人的身份**用锁把门给拴上。

   ```bash
   cat ~/.ssh/id_rsa.pub | ssh taujiong@192.168.1.118 "test -d .ssh || mkdir .ssh; cat >> ~/.ssh/authorized_keys"
   ```

   执行该命令会要求输出用户密码（验证主人的身份），然后该命令会将公钥文件中的内容拷贝到服务器实例中的 `~/.ssh/authorized_keys` 位置（用锁把门给拴上）。

3. 在你想要访问的时候，用钥匙把锁打开就能进门了。

   ```bash
   ssh taujiong@192.168.1.118
   ```

   此时，你已经不需要输入密码就能登录了（进门）。

声明一点，此处的比喻在操作逻辑上是恰当的，但是在真实的验证逻辑上是十分不恰当的。真实的逻辑是：

1. 创建一对密钥，本例中公钥为 id_rsa.pub，私钥为 ids_rsa
2. 把公钥放在需要访问的服务器上，本例中就是将 id_rsa.pub 中的内容传输到服务器主机对应用户根目录的相应文件中 `~/.ssh/authorized_keys`，至于执行的那条命令的具体解释大家自行理解吧，不难
3. 登录时的具体步骤：
   1. 客户端携带公钥向服务器请求进行安全验证
   2. 服务器判断请求中携带的公钥是否受信任的文件中。如果在，服务器就用公钥加密“质询”(challenge)并把它发送给客户端软件
   3. 客户端软件收到“质询”之后用私钥在本地解密再把它发送给服务器完成登录
   4. 如果公钥不受信任或者私钥认证失败，就正常走密码登录的流程

## GUI 方式连接云服务器

至此，我们已经能够成功地，随时随地地连接到我们的 Linux 服务器了，但是还不够优雅，不够方便。主要存在两点可以改善的地方：

- 每次连接时需要输入用户名和 ip 地址，其中 ip 地址记忆麻烦
- 连接成功后也只存在一个干巴巴的命令提示行，虽然该有的功能一个不落，但是没有 GUI 界面始终差了那么点意思

针对第一点，引入 ssh [config 文件](https://linux.die.net/man/5/ssh_config)，文件路径为 `~/.ssh/conig`。

```plain
Host laptop
    HostName 192.168.1.118
    User taujiong
```

至此，我们可以使用命令 `ssh laptop` 访问我们的服务器了。至于更多的参数配置，查阅上面的链接即可。

针对第二点，引入 VSCode（永远的神）。建议安装插件 [Remote Development](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.vscode-remote-extensionpack) 一步到位或者具体一点 [Remote - SSH](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh) 和 [Remote - SSH: Editing Configuration Files](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-ssh-edit)。

具体的使用就不详细介绍了，使用过程中会慢慢熟悉的。

## 总结

建立连接是我们使用云服务器的第一步，也是最基础的一步，最主要的概念和操作本文已经都包含了。

Linux 的基本命令没什么可说的，就一句话：熟能生巧。常用的命令我之前总结过，也发出来了，大家在 linux 的标签下找找就行。

以上。
